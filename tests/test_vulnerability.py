import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock
from docling_lib.converter import process_pdf

@pytest.fixture(autouse=True)
def reset_shared_converter():
    """Resets the shared default converter before and after each test."""
    import docling_lib.converter as converter_mod
    converter_mod._default_pdf_converter = None
    yield
    converter_mod._default_pdf_converter = None

@patch('docling_lib.converter.DocumentConverter')
def test_process_pdf_with_directory_vulnerability_fixed(
    MockDocumentConverter, tmp_path, monkeypatch
):
    """
    Check fix: Path traversal using '..' should be blocked.
    """
    monkeypatch.chdir(tmp_path)
    pdf_path = tmp_path / "test.pdf"
    pdf_path.touch()

    # Attempt to save to a directory outside tmp_path
    outside_dir = tmp_path / ".." / "vulnerable_output"

    result = process_pdf(pdf_path, outside_dir)

    assert result is None
    # Converter should NOT be called
    assert MockDocumentConverter.return_value.convert.call_count == 0

@patch('docling_lib.converter.DocumentConverter')
def test_process_pdf_with_non_pdf_file_vulnerability_fixed(
    MockDocumentConverter, tmp_path, monkeypatch
):
    """
    This test is now less relevant as Docling supports many formats,
    but we keep it to ensure it doesn't crash on non-existent or 
    completely invalid files (which is handled by docling or file checks).
    """
    monkeypatch.chdir(tmp_path)
    non_existent_file = tmp_path / "missing.pdf"

    result = process_pdf(non_existent_file, tmp_path / "output")

    assert result is None
    assert MockDocumentConverter.return_value.convert.call_count == 0
