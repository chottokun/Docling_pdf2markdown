import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock
from docling_lib.converter import process_pdf

@patch('docling_lib.converter.DocumentConverter')
def test_process_pdf_with_directory_vulnerability_fixed(MockDocumentConverter, tmp_path):
    """
    Check fix: A directory should not reach the converter.
    """
    dir_path = tmp_path / "test_dir"
    dir_path.mkdir()

    result = process_pdf(dir_path, tmp_path / "output")

    assert result is None
    # Now it should NOT be called
    MockDocumentConverter.return_value.convert.assert_not_called()

@patch('docling_lib.converter.DocumentConverter')
def test_process_pdf_with_non_pdf_file_vulnerability_fixed(MockDocumentConverter, tmp_path):
    """
    Check fix: A non-PDF file should not reach the converter.
    """
    txt_file = tmp_path / "test.txt"
    txt_file.write_text("This is not a PDF")

    result = process_pdf(txt_file, tmp_path / "output")

    assert result is None
    # Now it should NOT be called
    MockDocumentConverter.return_value.convert.assert_not_called()

@patch('docling_lib.converter.DocumentConverter')
def test_process_pdf_with_uppercase_pdf_extension_mocked(MockDocumentConverter, tmp_path):
    """
    Acceptance check: .PDF extension should be accepted. (Mocked to avoid network/conversion)
    """
    # Create a dummy .PDF file
    pdf_file = tmp_path / "test.PDF"
    pdf_file.write_text("dummy pdf content")

    # Mock return value to avoid further errors in process_pdf
    mock_doc = MagicMock()
    MockDocumentConverter.return_value.convert.return_value.document = mock_doc

    result = process_pdf(pdf_file, tmp_path / "output")

    # It should reach the converter
    MockDocumentConverter.return_value.convert.assert_called_once_with(pdf_file)
    assert result is not None
